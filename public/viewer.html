<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Viewer</title>
<style>
  body { margin:0; background:#111; color:white; font-family:sans-serif; }
  #local { width:300px; background:black; }
  #status { padding:10px; background:#222; font-size:14px; }
  .ok { color:#4CAF50; }
  .ng { color:#F44336; }
</style>
</head>
<body>

<div id="status">
  HTML読み込み: <span class="ok">OK</span><br>
  JS読み込み: <span id="js" class="ok">OK</span><br>
  offer送信: <span id="offer" class="ng">NG</span><br>
  answer受信: <span id="answer" class="ng">NG</span><br>
  WebRTC接続: <span id="rtc" class="ng">NG</span>
</div>

<video id="local" autoplay muted></video>

<script>
const pc = new RTCPeerConnection();
const channel = pc.createDataChannel("control");

pc.onicecandidate = e => {
  if (e.candidate) {
    fetch("/api/signal?action=candidate_viewer", {
      method: "POST",
      body: JSON.stringify(e.candidate)
    });
  }
};

pc.onconnectionstatechange = () => {
  if (pc.connectionState === "connected") {
    document.getElementById("rtc").textContent = "OK";
    document.getElementById("rtc").className = "ok";
  }
};

async function start() {
  const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
  document.getElementById("local").srcObject = stream;
  stream.getTracks().forEach(t => pc.addTrack(t, stream));

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await fetch("/api/signal?action=offer", {
    method: "POST",
    body: JSON.stringify(offer)
  });

  document.getElementById("offer").textContent = "OK";
  document.getElementById("offer").className = "ok";

  const waitAnswer = async () => {
    const res = await fetch("/api/signal");
    const data = await res.json();

    if (data.answer) {
      await pc.setRemoteDescription(data.answer);
      document.getElementById("answer").textContent = "OK";
      document.getElementById("answer").className = "ok";
    }

    if (data.candidates_client) {
      for (const c of data.candidates_client) {
        pc.addIceCandidate(c);
      }
    }

    requestAnimationFrame(waitAnswer);
  };

  waitAnswer();
}

start();
</script>
</body>
</html>
